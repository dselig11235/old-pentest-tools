#!/bin/bash

name="$1"
email="$2"
host="$3"
port="$4"
domain=${email#*@}

. ~/bin/screenshot-functions.sh
type() {
    xdotool type --window "$winid" "$1"; xdotool key --window "$winid" Return
}

(
    sleep 2
    type "HELO $domain"
    sleep .5
    type "MAIL From: $email"
    sleep .5
    type "RCPT To: $email"
    sleep .5
    type "DATA"
    sleep .5
    type "From: $email"
    type "Subject: TraceSecurity SMTP Server Test"
    type
    type "$name,"
    type
    type "This message is part of an external penetration test performed by TraceSecurity.  "
    type "If this message is received, please take a screenshot and send it to daniels@tracesecurity.com"
    type "."
    sleep .5
    type "QUIT"
) &

clear
echo -e "${red}bash-4.3#$nc telnet $host $port"
telnet $host $port
kill %1
sz=$((25*16))
import -window "$winid" -crop "800x$sz+12+14" "SMTP Internal Spoof Test on $host:$port.png"

