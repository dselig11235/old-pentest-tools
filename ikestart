#!/bin/bash


. $HOME/.profile
. ~/bin/target-functions.sh
winid="$(xdotool getwindowfocus -f)"
showikescan() {
    host="$1"
    clear
    fakeprompt ike-scan -M -A -P"$host.ike-psk" "$host"
    if test -e "$host.ike-psk"; then
        echo -e "${red}bash-4.3#$nc cat $host.ike-psk"
        partpsk=$(cut -b -70 "$host.ike-psk")
        echo -e "$partpsk${yellow}...(REDACTED)$nc"
        fakeprompt psk-crack $host.ike-psk
        return 0
    fi
    return 1
}

for host in `cat targets.ike`; do 
    host=$(gethost "$host")
    temp=`mktemp`
    name="Attempted Agressive Mode IKE-Scan on $host"
    showikescan "$host" | tee "$temp"
    if test ${PIPESTATUS[0]} -eq 0; then
        name="IKE Agressive Mode Handshake on $host"
    fi
    declare -i sz=`awk 'END {print NR}' "$temp"`
    sz=$((sz*160/10))
    mv "$temp" "$name.spl"
    import -window "$winid" -crop "800x$sz+12+14" "$name.png"
done

