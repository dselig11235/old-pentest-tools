#!/bin/bash

userpass="$1"
. ~/bin/screenshot-functions.sh
type() {
    xdotool type --window "$winid" "$1"; xdotool key --window "$winid" Return
}

for target in `cat targets.telnet`; do
    host=${target%:*}
    port=${target#*:}
    out="Automated Telnet Login on ${target//:\/\//_}"
    (
        sleep 2
        readarray creds < <(cat $userpass)
        for cred in "${creds[@]}"; do
            u="${cred%%:*}"
            p="${cred#*:}"
            type "$u"
            sleep .5
            type "p"
            sleep 3
        done
        type
    ) &

    clear
    echo -e "${red}bash-4.3#$nc telnet $host $port" | tee "$out.spl"
    telnet $host $port |& tee --append "$out.spl"
    kill %1
    declare -i sz=`awk 'END {print NR}' "$out.spl"`
    sz=$(((sz+4)*16))
    import -window "$winid" -crop "800x$sz+12+14" "$out.png"
done
